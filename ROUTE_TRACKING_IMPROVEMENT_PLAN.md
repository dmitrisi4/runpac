# План улучшения отслеживания маршрута

## Проблема
Текущая система отслеживания рисует прямые линии между GPS-точками, что приводит к неточному отображению маршрута - линии проходят сквозь здания и не следуют по дорогам.

## Причины проблемы
1. **Низкая частота обновления GPS** - точки записываются слишком редко
2. **Отсутствие привязки к дорогам** - нет snap-to-road функциональности
3. **Прямые линии между точками** - используется простая интерполяция
4. **Неточность GPS в городских условиях** - сигнал отражается от зданий

## Решения (по приоритету)

### 1. Увеличение частоты записи GPS-точек
**Приоритет: Высокий**
**Сложность: Низкая**

- Уменьшить интервал записи с текущего до 1-2 секунд
- Добавить фильтрацию по минимальному расстоянию (например, 5 метров)
- Реализовать адаптивную частоту в зависимости от скорости движения

```javascript
// Пример настроек
const GPS_OPTIONS = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 1000 // Обновлять каждую секунду
};
```

### 2. Фильтрация неточных GPS-точек
**Приоритет: Высокий**
**Сложность: Средняя**

- Отбрасывать точки с низкой точностью (accuracy > 20 метров)
- Фильтровать аномальные скачки (телепортация)
- Использовать алгоритм сглаживания Калмана

```javascript
const isValidGPSPoint = (newPoint, lastPoint) => {
  if (newPoint.accuracy > 20) return false;
  
  const distance = calculateDistance(newPoint, lastPoint);
  const timeDiff = (newPoint.timestamp - lastPoint.timestamp) / 1000;
  const speed = distance / timeDiff; // м/с
  
  return speed < 15; // Максимальная скорость бега ~15 м/с
};
```

### 3. Интеграция с API маршрутизации
**Приоритет: Средний**
**Сложность: Высокая**

- Использовать Google Roads API или OpenStreetMap Routing
- Привязывать GPS-точки к ближайшим дорогам
- Строить маршрут между точками по дорожной сети

```javascript
// Пример использования Google Roads API
const snapToRoads = async (points) => {
  const response = await fetch(
    `https://roads.googleapis.com/v1/snapToRoads?path=${points.join('|')}&key=${API_KEY}`
  );
  return response.json();
};
```

### 4. Локальное сглаживание маршрута
**Приоритет: Средний**
**Сложность: Средняя**

- Использовать алгоритм Bezier curves для сглаживания
- Применять Douglas-Peucker для упрощения маршрута
- Интерполировать промежуточные точки

```javascript
// Пример сглаживания с помощью Turf.js
import { bezierSpline } from '@turf/bezier-spline';

const smoothPath = (points) => {
  const line = turf.lineString(points);
  return bezierSpline(line, { resolution: 10000, sharpness: 0.85 });
};
```

### 5. Оффлайн-карты и предварительная загрузка
**Приоритет: Низкий**
**Сложность: Высокая**

- Кэшировать карты района для оффлайн-использования
- Предварительно загружать данные о дорогах
- Использовать Service Worker для кэширования

## Этапы реализации

### Этап 1: Быстрые улучшения (1-2 дня)
1. Увеличить частоту GPS-обновлений
2. Добавить базовую фильтрацию точек
3. Реализовать проверку точности GPS

### Этап 2: Средние улучшения (3-5 дней)
1. Интегрировать алгоритм сглаживания
2. Добавить фильтрацию аномальных скачков
3. Оптимизировать производительность

### Этап 3: Продвинутые функции (1-2 недели)
1. Интеграция с Roads API
2. Реализация snap-to-road
3. Добавление настроек точности для пользователя

## Технические детали

### Настройки GPS
```javascript
const watchOptions = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 1000
};
```

### Фильтрация точек
```javascript
const MIN_ACCURACY = 20; // метры
const MAX_SPEED = 15; // м/с (54 км/ч)
const MIN_DISTANCE = 5; // метры между точками
```

### Библиотеки для использования
- **@turf/turf** - геопространственные вычисления
- **@turf/bezier-spline** - сглаживание маршрутов
- **@turf/simplify** - упрощение маршрутов
- **leaflet-routing-machine** - маршрутизация для Leaflet

## Метрики для оценки улучшений
1. **Точность маршрута** - процент точек на дорогах
2. **Плавность линии** - количество резких поворотов
3. **Производительность** - время обработки GPS-точек
4. **Расход батареи** - влияние на время работы устройства

## Альтернативные подходы
1. **Использование акселерометра** - для определения поворотов
2. **Машинное обучение** - предсказание маршрута на основе истории
3. **Краудсорсинг** - использование данных других пользователей

## Заключение
Начать следует с простых улучшений (этап 1), которые дадут быстрый результат с минимальными затратами. Затем постепенно добавлять более сложные функции в зависимости от потребностей пользователей и доступных ресурсов.